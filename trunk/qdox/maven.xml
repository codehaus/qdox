<?xml version="1.0"?>
<project xmlns:deploy="deploy" xmlns:m="maven" xmlns:j="jelly:core" xmlns:maven="jelly:org.apache.maven.jelly.tags.project.MavenTagLibrary">

	<goal name="release" description="Make new release">
		<m:user-check user="${maven.username}"/>
		<attainGoal name="website"/>

		<deploy:artifact
			artifact="target/${maven.final.name}.jar"
			type="jars"
			assureDirectoryCommand="mkdir -p"
		/>

		<attainGoal name="dist:deploy"/>
	</goal>

	<preGoal name="java:prepare-filesystem">
		<path id="lib">
			<fileset dir="lib"/>
		</path>
		<maven:addPath id="maven.dependency.classpath" refid="lib"/>
	</preGoal>

	<preGoal name="java:compile">
		<ant target="generate"/>
		<path id="generate.java" location="build/java"/>
		<maven:addPath id="maven.compile.src.set" refid="generate.java"/>
	</preGoal>

	<preGoal name="test:compile">
		<mkdir dir="target/test-src"/>
		<copy todir="target/test-src">
			<fileset dir="src/test"/>
			<fileset dir="build/test"/>
		</copy>
	</preGoal>

	<goal name="coverage">
		<property name="maven.junit.fork" value="yes"/>

		<delete dir="target/clover"/>
		<delete dir="${maven.build.dest}"/>
		<delete dir="${maven.test.dest}"/>

		<attainGoal name="test:compile" />

		<!-- recompile main classes cloverified -->
		<attainGoal name="clover:on"/>
		<delete dir="${maven.build.dest}"/>
		<attainGoal name="java:compile" />

		<attainGoal name="clover:html-report"/>

		<delete dir="${maven.build.dest}"/>
		<delete dir="${maven.test.dest}"/>
		<echo>${maven.junit.fork}</echo>
	</goal>
	
	<goal name="website">
		<attainGoal name="clean"/>
		<attainGoal name="test"/>
		<attainGoal name="java:jar"/>
		<attainGoal name="statistics"/>
		<attainGoal name="coverage"/>
		<attainGoal name="site:generate"/>
	</goal>
	
	<goal name="statistics">
		<attainGoal name="statcvs"/>
		<mkdir dir="target/docs/statcvs"/>
		<copy todir="target/docs/statcvs">
			<fileset dir="target/statcvs"/>
		</copy>
	</goal>
	
</project>

