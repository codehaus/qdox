<?xml version="1.0"?>
<project default="jar" xmlns:j="jelly:core" xmlns:maven="jelly:maven">

  <postGoal name="test:test">
    <attainGoal name="test:myway"/>
  </postGoal>

  <goal name="test:myway"
        description="Test the application, ala Piotr"
        prereqs="java:compile,test:prepare-filesystem,test:test-resources"> 
    <taskdef name="junit" 
             classname="org.apache.tools.ant.taskdefs.optional.junit.JUnitTask" />
    <junit printSummary="on" 
           failureProperty="maven.test.failure"
           fork="${maven.junit.fork}"
           dir="${maven.junit.dir}">
      <sysproperty key="basedir" value="${basedir}"/>
      <formatter type="xml"/>
      <classpath>
        <path refid="maven.dependency.classpath"/>
        <pathelement location="${maven.build.dest}"/>
        <pathelement location="${maven.build.dir}/attribs"/>
        <pathelement path="${plugin.getDependencyPath('junit')}"/>
      </classpath>
      <batchtest todir="${maven.build.dir}/test-reports">
        <fileset dir="${maven.build.dest}">
          <include name="**/*$Test*.class"/>
          <exclude name="**/*$Test*$*.class"/>
        </fileset>
      </batchtest>
    </junit>
  </goal>

  <goal name="jar:rt-jar" description="Create the deliverable jar file.">
    <jar jarfile="${maven.build.dir}/${maven.final.name}-rt.jar">
    	<fileset dir="${maven.build.dest}">
			<exclude name="**/*$Test*.class"/>
			<exclude name="com/thoughtworks/qdox/attributes/dev/*"/>
			<exclude name="com/thoughtworks/qdox/attributes/dev"/>
		</fileset>
		<fileset dir="${maven.build.dir}/attribs"/>
	</jar>
  </goal>
  
  <postGoal name="jar:jar">
    <attainGoal name="jar:rt-jar"/>
  </postGoal>
  
  <goal name="java:attribs" description="Compile project attributes.">
  	<mkdir dir="${maven.build.dir}/attribs"/>
  	<echo level="info" message="Compiling attributes to ${maven.build.dir}/attribs" />
  	<java classname="com.thoughtworks.qdox.attributes.dev.Compiler" failonerror="true" fork="true">
  		<arg value="-mode" />
  		<arg value="object" />
  		<arg value="-force" />
  		<arg value="-src" />
  		<arg file="${maven.src.dir}/java" />
  		<arg value="-dst" />
  		<arg file="${maven.build.dir}/attribs" />
		<classpath>
			<path refid="maven.dependency.classpath"/>
			<pathelement location="${maven.build.dest}"/>
		</classpath>
  	</java>
  </goal>
  
  <postGoal name="java:compile">
  	<attainGoal name="java:attribs"/>
  </postGoal>
  
</project>

